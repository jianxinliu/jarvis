# Jarvis Kubernetes 完整部署配置
# 包含所有资源：Namespace, ConfigMap, Deployment, Service, NodePort, Ingress
# 使用 hostPath 挂载跳板机上的 jarvis.db 文件
# 使用方式: kubectl apply -f jarvis-full.yaml
# 注意：使用前需要根据实际情况修改镜像地址、域名、hostPath 路径和节点选择器

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: jarvis-config
  namespace: sdk-h5
  labels:
    app: jarvis
data:
  # 应用配置
  APP_NAME: "Jarvis"
  DEBUG: "false"
  HOST: "0.0.0.0"
  PORT: "8000"
  
  # 数据库配置（使用 SQLite，通过 hostPath 挂载）
  # 注意：使用绝对路径，4个斜杠表示绝对路径
  DATABASE_URL: "sqlite:////app/data/jarvis.db"
  
  # 提醒配置
  MORNING_REMINDER_TIME: "08:00"
  
  # 日志配置
  ENABLE_LOGGING: "true"
  ENABLE_SQL_ECHO: "false"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jarvis
  namespace: sdk-h5
  labels:
    app: jarvis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jarvis
  template:
    metadata:
      labels:
        app: jarvis
    spec:
      # 指定节点：如果跳板机是 K8s 节点，使用 nodeName 指定节点名
      # 或者使用 nodeSelector 通过标签选择节点
      # nodeName: jump-server  # 替换为跳板机节点名
      # 或使用 nodeSelector:
      # nodeSelector:
      #   kubernetes.io/hostname: jump-server  # 替换为跳板机节点名
      imagePullSecrets:
        - name: wumi-hub
      containers:
      - name: jarvis
        # 镜像地址：需要根据实际情况修改
        # 选项1: 使用本地构建的镜像（需要先构建并推送到镜像仓库）
        # image: your-registry/jarvis:latest
        # 选项2: 使用华为云镜像（如果可访问）
        # image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/jarvis:latest
        # 选项3: 使用 Docker Hub 或其他公共镜像仓库
        image: uhub.service.ucloud.cn/wumitech.com/jarvis:2512201001
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 8000
          protocol: TCP
        envFrom:
        - configMapRef:
            name: jarvis-config
        volumeMounts:
        # 挂载数据目录（包含数据库文件和 Excel 规则配置等，从跳板机 hostPath）
        # 注意：挂载整个目录，数据库文件应该在 /app/data/jarvis.db
        # Excel 规则目录应该在 /app/data/excel_rules/
        - name: jarvis-data
          mountPath: /app/data
          readOnly: false  # 允许读写，因为需要创建/更新数据库和规则文件
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 8000
          initialDelaySeconds: 40
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/health
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
      # 挂载跳板机上的数据目录
      # 注意：
      # 1. 跳板机上应该有以下结构：
      #    /home/ubuntu/liujianxin/jarvis/jarvis.db (数据库文件)
      #    /home/ubuntu/liujianxin/jarvis/excel_rules/ (Excel 规则目录，可选)
      # 2. 如果目录不存在，K8s 会创建，但文件不会自动创建
      # 3. 确保跳板机节点有正确的权限访问该目录
      - name: jarvis-data
        hostPath:
          path: /home/ubuntu/liujianxin/jarvis
          type: DirectoryOrCreate  # 如果目录不存在则创建

---
apiVersion: v1
kind: Service
metadata:
  name: jarvis
  namespace: sdk-h5
  labels:
    app: jarvis
spec:
  type: ClusterIP
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: jarvis

---
# Ingress (可选，需要先配置域名和 Ingress Controller)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jarvis-ingress
  namespace: sdk-h5
  labels:
    app: jarvis
  annotations:
    # 根据你的 Ingress Controller 类型修改注解
    # Nginx Ingress Controller
    # nginx.ingress.kubernetes.io/rewrite-target: /
    # Traefik
    # traefik.ingress.kubernetes.io/rule-type: PathPrefix
spec:
  ingressClassName: nginx  # 根据实际情况修改
  rules:
  - host: jarvis.zrqsmcx.top  # 修改为你的域名
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: jarvis
            port:
              number: 8000

